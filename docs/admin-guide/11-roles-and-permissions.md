# Система ролей и иерархия уровней

## Обзор системы RBAC

Платформа использует систему контроля доступа на основе ролей (RBAC) с **5-уровневой иерархией**.

Роли определяют не только набор прав доступа, но и **уровень в иерархии** от 0 (максимальный) до 4 (минимальный).

## Иерархия уровней

Система построена на 5 уровнях доступа:

| Уровень | Название | Назначение | Системные роли |
|---------|----------|------------|----------------|
| **0** | System Owner | Владелец системы, полный контроль | `superadmin` |
| **1** | Executive | Высший уровень управления (резерв для кастомных ролей) | - |
| **2** | Administrator | Административный уровень | `admin` |
| **3** | Staff | Сотрудники (резерв для кастомных ролей) | - |
| **4** | Student | Конечные пользователи | `student` |

**Важно:** Чем **меньше** число уровня, тем **выше** права в иерархии.

## Системные роли

### Level 0: Superadmin (Супер-администратор)

**Полный контроль над системой**

Права:
- **Студенты**: чтение, управление, удаление, сброс, просмотр прогресса
- **Курсы**: чтение, управление, удаление
- **Документация**: чтение, редактирование, публикация, архивация, управление структурой
- **Экзамены**: проверка, переопределение результатов
- **Каталог**: управление группами, тегами курсов и пользователей
- **Персонал**: управление сотрудниками
- **Роли**: создание, редактирование, удаление, назначение ролей
- **Система**: просмотр логов входа, управление настройками

**Особенности:**
- Может управлять ВСЕМИ пользователями, включая других superadmin
- Может назначать ЛЮБЫЕ роли любым пользователям
- Единственный уровень, который может создавать и удалять кастомные роли
- **Защита**: нельзя понизить последнего superadmin в системе

### Level 2: Admin (Администратор)

**Базовая административная роль**

Права:
- **Студенты**: чтение, управление, сброс прогресса
- **Документация**: чтение, редактирование
- **Экзамены**: проверка

**Ограничения:**
- Не может управлять пользователями уровня 0, 1, 2 (включая других админов)
- Не может назначать роли уровня 0, 1, 2
- Может назначать только роль `student` (уровень 4)
- Не может создавать/удалять роли
- Не может изменить свою собственную роль

### Level 4: Student (Студент)

**Базовый пользователь системы обучения**

- Не имеет административных прав
- Доступ только к учебным материалам согласно своим курсам

**Требование:** Пользователь со студенческой ролью **обязательно** должен иметь `static_id` (идентификатор студента).

## Кастомные роли (уровни 1-3)

Superadmin может создавать **кастомные роли** на уровнях 1, 2 и 3.

### Правила создания кастомных ролей

1. **Уровни**: Только от 1 до 3 (MIN_CUSTOM_ROLE_LEVEL=1, MAX_CUSTOM_ROLE_LEVEL=3)
2. **Имена**: Не должны совпадать с зарезервированными (`superadmin`, `admin`, `student`, `executive`, `manager`, `staff`)
3. **Права**: Любая комбинация из 25 доступных прав
4. **Системные роли**: Нельзя изменить или удалить (`is_system=1`)

### Примеры кастомных ролей

**Уровень 1 (Executive):**
- `director` — Директор учебного центра
- `chief_methodist` — Главный методист

**Уровень 2 (Manager):**
- `course_manager` — Менеджер курсов
- `content_editor` — Редактор контента

**Уровень 3 (Staff):**
- `tutor` — Преподаватель
- `moderator` — Модератор

## Правила иерархии

### 1. Управление пользователями

**Правило:** Можно управлять только пользователями с **более высоким** уровнем (большее число).

```
canManageUser(actorLevel, targetLevel) = targetLevel > actorLevel
```

**Примеры:**
- ✅ Admin (L2) → управляет Student (L4) — уровень 4 > 2
- ❌ Admin (L2) → управляет другим Admin (L2) — уровень 2 = 2
- ❌ Admin (L2) → управляет Superadmin (L0) — уровень 0 < 2

**Исключение:** Superadmin (L0) может управлять ЛЮБЫМИ пользователями, включая других superadmin.

### 2. Назначение ролей

**Правило:** Можно назначать только роли с **более высоким** уровнем (большее число), чем ваш собственный.

```
canAssignRole(actorLevel, roleLevel) = roleLevel > actorLevel
```

**Примеры:**
- ✅ Admin (L2) → назначает Student (L4) — уровень 4 > 2
- ❌ Admin (L2) → назначает Admin (L2) — уровень 2 = 2
- ❌ Admin (L2) → назначает Superadmin (L0) — уровень 0 < 2

**Исключение:** Superadmin (L0) может назначать ЛЮБЫЕ роли.

### 3. Защита от изменения собственной роли

**Правило:** Пользователь **не может** изменить свою собственную роль, даже superadmin.

**Причина:** Безопасность. Это предотвращает случайное или намеренное снижение собственных прав.

### 4. Защита последнего superadmin

**Правило:** Нельзя понизить последнего superadmin в системе.

**Как это работает:**
- Если в системе только 1 пользователь с уровнем 0, его роль нельзя изменить
- Сначала нужно назначить роль superadmin другому пользователю
- Только после этого можно понизить первого superadmin

**Почему это важно:** Гарантирует, что всегда будет хотя бы один пользователь с полным доступом к системе.

## Список всех прав (permissions)

### Студенты (students.*)
- `students.read` — Просмотр списка студентов
- `students.manage` — Создание и редактирование студентов
- `students.delete` — Удаление студентов
- `students.reset` — Сброс прогресса студентов
- `students.progress` — Просмотр детального прогресса

### Курсы (courses.*)
- `courses.read` — Просмотр курсов
- `courses.manage` — Создание и редактирование курсов
- `courses.delete` — Удаление курсов

### Документация (docs.*)
- `docs.read` — Чтение документации
- `docs.edit` — Редактирование документации
- `docs.publish` — Публикация документов
- `docs.archive` — Архивация документов
- `docs.structure` — Управление структурой документации

### Экзамены (exams.*)
- `exams.review` — Проверка экзаменов
- `exams.override` — Переопределение результатов экзаменов

### Каталог (catalog.*)
- `catalog.groups` — Управление группами курсов
- `catalog.tags.course` — Управление тегами курсов
- `catalog.tags.user` — Управление тегами пользователей

### Персонал (staff.*)
- `staff.manage` — Управление сотрудниками

### Роли (roles.*)
- `roles.manage` — Создание, редактирование, удаление ролей
- `roles.assign` — Назначение ролей пользователям

### Система (system.*)
- `logins.view` — Просмотр логов входа
- `system.settings` — Управление системными настройками

## Управление ролями

### Создание кастомной роли

**Доступно только superadmin** (право `roles.manage`).

1. Откройте раздел **"Роли"**
2. Нажмите **"+ Создать роль"**
3. Заполните форму:
   - **Имя** (name) - системное имя роли (латиница, без пробелов)
   - **Отображаемое имя** (display_name) - как будет показано в интерфейсе
   - **Описание** - назначение роли
   - **Уровень** - от 1 до 3
   - **Права** - выберите из списка доступных прав
4. Нажмите **"Создать"**

**Ограничения:**
- Имя не должно совпадать с зарезервированными: `superadmin`, `admin`, `student`, `executive`, `manager`, `staff`
- Уровень только от 1 до 3 (уровни 0 и 4 — системные)
- Все поля обязательны

### Изменение кастомной роли

1. Откройте раздел **"Роли"**
2. Найдите нужную роль
3. Нажмите **"Редактировать"**
4. Измените:
   - Отображаемое имя
   - Описание
   - Набор прав
5. Нажмите **"Сохранить"**

**Ограничения:**
- Нельзя изменить системные роли (`is_system=1`)
- Нельзя изменить уровень после создания
- Нельзя изменить имя роли

### Удаление кастомной роли

1. Откройте роль
2. Нажмите **"Удалить"**
3. Подтвердите удаление

**Ограничения:**
- Нельзя удалить системные роли
- Нельзя удалить роль, если она назначена хотя бы одному пользователю

### Назначение роли пользователю

**Доступно superadmin и admin** (право `roles.assign`), но с ограничениями по иерархии.

1. Откройте карточку пользователя
2. Нажмите **"Изменить роль"**
3. Выберите новую роль из списка
4. Нажмите **"Сохранить"**

**Валидация:**
- Нельзя изменить свою собственную роль
- Admin (L2) может назначать только роли уровня 3-4
- Superadmin (L0) может назначать любые роли
- Нельзя назначить роль `student` пользователю без `static_id`
- Нельзя понизить последнего superadmin

## Аудит ролей

Все операции с ролями записываются в журнал аудита:
- Назначение роли пользователю (`role.assign`)
- Создание новой роли (`role.create`)
- Изменение прав роли (`role.update`)
- Удаление роли (`role.delete`)

Запись включает:
- Кто выполнил действие (actor)
- Когда было выполнено
- Что изменилось (старое и новое значение)
- Целевой пользователь (если применимо)

## Типичные сценарии

### Сценарий 1: Создание роли "Преподаватель" (уровень 3)

```
1. Superadmin открывает "Роли"
2. Нажимает "+ Создать роль"
3. Вводит:
   - Имя: "tutor"
   - Отображаемое имя: "Преподаватель"
   - Описание: "Проверяет экзамены и управляет студентами"
   - Уровень: 3
   - Права: [students.read, students.manage, exams.review, docs.read]
4. Нажимает "Создать"
5. ✅ Роль создана и доступна для назначения
```

### Сценарий 2: Назначение кастомной роли пользователю

```
1. Superadmin открывает карточку администратора
2. Текущая роль: admin (L2)
3. Нажимает "Изменить роль"
4. Выбирает "tutor" (L3)
5. Нажимает "Сохранить"
6. ✅ Пользователь понижен с L2 до L3
7. Теперь имеет только права: students.read, students.manage, exams.review, docs.read
```

### Сценарий 3: Admin пытается назначить роль superadmin

```
1. Admin (L2) открывает карточку студента (L4)
2. Нажимает "Изменить роль"
3. Пытается выбрать "superadmin" (L0)
4. ❌ Система блокирует: "Недостаточно прав: нельзя назначать роль своего уровня или выше"
5. Admin видит в списке только роли уровня 3-4
```

### Сценарий 4: Защита последнего superadmin

```
1. В системе только 1 superadmin
2. Superadmin пытается изменить свою роль на admin
3. ❌ Ошибка: "Нельзя изменить свою собственную роль"
4. Другой superadmin пытается понизить его
5. ❌ Ошибка: "Нельзя понизить последнего суперадминистратора"

Решение:
1. Сначала создать второго superadmin
2. Потом понизить первого
```

## Частые ошибки

### ❌ Ошибка 1: Нельзя создать роль с уровнем 0 или 4

**Что произойдёт:**
- Система покажет ошибку: "Уровень кастомной роли должен быть от 1 до 3"

**Решение:**
- Уровни 0 и 4 зарезервированы для системных ролей (superadmin и student)
- Используйте уровни 1, 2 или 3

### ❌ Ошибка 2: Имя роли совпадает с зарезервированным

**Что произойдёт:**
- Ошибка: "Имя роли зарезервировано системой"

**Решение:**
- Не используйте имена: superadmin, admin, student, executive, manager, staff
- Придумайте уникальное имя

### ❌ Ошибка 3: Админ не видит раздел "Роли"

**Это нормально!**
- У admin нет права `roles.manage`
- Только superadmin может управлять ролями

**Решение:**
- Если админу нужны права на роли - повысьте его до superadmin

### ❌ Ошибка 4: Нельзя удалить роль, назначенную пользователям

**Что произойдёт:**
- Ошибка: "Невозможно удалить роль: назначена X пользователям"

**Решение:**
1. Найдите всех пользователей с этой ролью
2. Переназначьте им другую роль
3. Потом удалите роль

## Рекомендации по проектированию ролей

### Общие принципы

1. **Минимальные права** - давайте только необходимые права
2. **Разделение обязанностей** - разные роли для разных задач
3. **Защита критичных операций** - только для высших уровней

### Примеры структуры ролей

**Образовательная организация:**

```
Level 0: superadmin (владелец системы)
Level 1: director (директор учебного центра)
         - students.*, courses.read, docs.*, exams.*, catalog.*
Level 2: course_manager (менеджер курсов)
         - courses.*, students.read, docs.read
Level 2: content_editor (редактор контента)
         - docs.*, courses.read
Level 3: tutor (преподаватель)
         - students.read, students.manage, exams.review, docs.read
Level 3: support (техподдержка)
         - students.read, students.reset, docs.read
Level 4: student (обучающийся)
```

**Корпоративное обучение:**

```
Level 0: superadmin (IT-администратор)
Level 1: training_director (директор по обучению)
         - students.*, courses.*, docs.*, catalog.*
Level 2: hr_manager (HR-менеджер)
         - students.*, catalog.groups, catalog.tags.user
Level 2: methodist (методист)
         - courses.*, docs.*, exams.*
Level 3: trainer (тренер)
         - students.read, students.progress, exams.review, docs.read
Level 4: employee (сотрудник)
```

## Вопросы и ответы

### Сколько кастомных ролей можно создать?

✅ **Неограниченно.** Можно создать любое количество ролей на уровнях 1-3.

### Можно ли изменить уровень роли после создания?

❌ **Нет.** Уровень фиксируется при создании и не может быть изменен.

**Решение:** Создайте новую роль с нужным уровнем, переназначьте пользователей, удалите старую.

### Что если пользователь имеет несколько ролей?

❌ **Невозможно.** У каждого пользователя только ОДНА роль.

### Admin может создавать кастомные роли?

❌ **Нет.** Только superadmin имеет право `roles.manage`.

### Можно ли дать роли уровня 3 право на управление курсами?

✅ **Да.** При создании роли можно выбрать любую комбинацию прав, независимо от уровня.

**Но учитывайте иерархию:** Пользователь с уровнем 3 не сможет управлять пользователями уровня 0-3.

### Как проверить какие права у конкретного пользователя?

1. Откройте карточку пользователя
2. Посмотрите его роль
3. Откройте раздел "Роли"
4. Найдите эту роль
5. Увидите список всех прав

Или проверьте в журнале аудита последнее назначение роли.

---

[← Предыдущая: Создание студентов](10-creating-students.md) | [Назад к содержанию](README.md) | [Следующая: Матрица прав →](12-roles-matrix.md)
