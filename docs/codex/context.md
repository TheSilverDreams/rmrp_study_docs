# Codex Working Context

## Documentation Portal Rework (current focus)

- **Goal.** Раздел документации должен стать основным источником материалов для пользователей с правом `docs.read`. Публичный (для авторизованных) интерфейс показывает только опубликованные документы, оформленные в виде плиток.

### Data & Permissions
- Категория документа = секция. Нужно добавить сортировку, slug для публичных ссылок, выбор иконки из набора Lucide.
- Вводим справочник тегов доступа. Документ может требовать один/несколько тегов; пользователь должен иметь совпадающий тег, иначе документ не показываем.
- `docs.read` получают все роли по умолчанию, ограничения строятся именно на тегах. Черновики/архивы скрываем с публичной стороны.
- Версионность остаётся — читатель видит последнюю опубликованную версию, админ может просматривать историю.

### Backend Tasks
1. Расширить схему БД:
   - Категории: порядок, slug, icon.
   - Таблица тегов доступа и связь документ ↔ теги, пользователь ↔ теги.
2. Реализовать CRUD:
   - Категории (создание, обновление, удаление, изменение порядка).
   - Теги доступа.
   - Обновить сервис документов для работы с тегами и фильтрацией выдачи.
3. API слоя:
   - Админские маршруты для категорий и тегов (реализовано).
   - Публичные маршруты `/api/docs` (список плиток, детальная статья, хлебные крошки) — реализовано.
   - Проверка доступа по тегам на уровне выборки — реализовано.

### Frontend Tasks
1. Публичная часть `/docs`:
   - Плиточная сетка (адаптив: 1 карточка на мобилке) с иконкой, заголовком и кратким описанием.
   - Группировка по категориям, фильтр по тегам.
   - Страница статьи: хлебные крошки `Документация → Категория → Документ`, markdown-контент, автор/дата, иконка в шапке.
2. Админка `/admin/docs`:
   - Новая сетка: фильтры по аудитории/категории/тегу, плитки с иконками.
   - Формы и модалки для категорий (иконки Lucide) и тегов доступа.
   - Редактор документа с выбором иконки и тегов, dropdown «Действия» для статусов.
   - Управление вложениями и статусами в обновлённом просмотре.

3. Markdown:
   - Подтянуть стили, чтобы визуально совпадало с предпросмотром, особенно списки/цитаты.

### Testing & Verification
- Прогнать миграции, проверить фильтрацию по тегам и статусам.
- Ручные сценарии: пользователь без тегов видит только «общие» документы; пользователь с тегом — расширенный список; админ управляет категориями/тегами и документами; действия из меню работают.

### Status Notes
- 2025‑10‑19: заданы требования и план (см. выше).
- 2025‑10‑19: Step 1 — миграции + сервисы для категорий/тегов и фильтрация по тегам.
- 2025‑10‑19: Step 2 — backend API: модульные роуты категорий/тегов/документов, публичный /api/docs, сиды с docs.* правами.

- Перевести управление доступами на единый справочник пользовательских тегов (вместо отдельного document_access_tags):
  - добавить slug/order для NamedTag, мигрировать данные;
  - переписать документы на новый источник;
  - обновить UI (редактор документов, фильтры, выдача тегов пользователям);
  - учесть права на каталоги и управление тегами.
