# RMRP — руководство по функционалу

Документ описывает текущие возможности платформы и сценарии работы для всех ролей.

## Термины
- **Материал** — сущность уровня курса, включает несколько модулей.
- **Модуль** — блок материала (`Теория` или `Квиз`).
- **Группа** — папка/группа доступа. Материал принадлежит одной группе, пользователю назначается группа доступа.
- **Теги** — произвольные метки. Материал может иметь несколько тегов, пользователь — набор тегов доступа.
- **Статик ID** — короткий идентификатор, используемый при создании логина.

## Роли
### Пользователь (role=student)
- **Личный кабинет**: список материалов, прогрессбар, статус модулей.
- **Теоретический модуль**: просмотр Markdown + видео, кнопка «Отметить модуль как изученный». Если модуль уже отмечен, кнопка превращается в «Я ознакомился ещё раз, я молодец».
- **Квиз**:
  - `questionCount` задаёт число вопросов. Вопросы выбираются из общего пула с приоритетом «редко встречавшихся» для этого пользователя.
  - Варианты ответов перемешиваются.
  - После сдачи выводится результат и подробный разбор: правильные ответы подсвечены зелёным, выбранные неверные — красным, и отображается пояснение (`explain`).
  - Кнопки «Повторить попытку» и «Закрыть» доступны сразу после результата.

### Администратор (role=admin)
- **Управление аккаунтами**: список пользователей, фильтры по серверу, статик-ID, группе, тегам.
- **Создание пользователя**:
  - поля: Ник, Статик ID, Сервер, Пароль (опционально), Группа доступа, Теги доступа.
  - логин формируется автоматически (`{staticId}@{server}`).
  - после создания показывается модальное окно с логином/паролем.
- **Сброс пароля**: генерация нового пароля, отображение модального окна.
- **Карточка прогресса**:
  - выводит сведения о пользователе (группа, теги, статик ID);
  - для каждого материала отображается прогресс, привязка к группе и тегам, статус модулей.

### Суперадмин (role=superadmin)
- **Материалы (`/superadmin/courses`)**:
  - фильтры по группе и тегам;
  - мастер создания (по желанию автоматически добавляет теорию и квиз с заданными параметрами);
  - выбор группы и тегов, статус (Активен/Скрыт);
  - настройки мастера: названия модулей, текст по умолчанию, количество вопросов, проходной балл;
  - кнопки: «Предпросмотр», «Редактировать», «Скрыть/Активировать», «Дублировать».
- **Редактор материала**:
  - редактирование метаданных (группа, теги, статус, описание);
  - создание модулей (теория + Markdown редактор, квиз + мета);
  - дублирование модулей, изменение порядка, редактирование контента;
  - запуск предпросмотра конкретного материала.
- **Вопросы**: 
  - создание/редактирование вопросов (одиночный/множественный выбор, варианты, пояснение, теги);
  - вопросы автоматически попадают в пул, доступный всем квизам материала.
- **Справочник групп и тегов (`/superadmin/catalog`)**:
  - управление группами материалов (название, описание, порядок, активность);
  - управление тегами материалов и тегами пользователей.

## Поведение квиза
1. При старте запрос `POST /modules/:moduleId/quiz/start`:
   - модуль типа `quiz` → чтение меты (`questionCount` и `passPercent`).
   - фильтрация вопросов по тегам (если заданы у модуля).
   - ранжирование по числу показов для конкретного пользователя (используются записи из `attempts`).
   - выборка `questionCount` вопросов из наименее используемых, затем перемешивание порядка.
   - перемешивание ответов для каждого вопроса.
   - сохранение payload (пара вопросов, правильные варианты, текст, пояснение, mix вариантов) в `attempts` со статусом `in_progress`.
2. После отправки ответов `POST /modules/:moduleId/quiz/submit`:
   - ответы сортируются, сравниваются с правильными.
   - высчитывается балл и статус (`passed`, если `% >= passPercent`).
   - payload обновляется, попытка получает финальный статус/score.
   - в ответе возвращается массив `details` для отображения разбора (нужен для подсветок и пояснений).

## Сценарий создания материала с мастером
1. Перейти в `Материалы` → `Создать материал`.
2. Указать название, описание, группу, теги, статус.
3. Отметить чекбокс «Создать типовой набор модулей».
4. Настроить названия теории/квиза, markdown по умолчанию, количество вопросов, проходной балл.
5. После сохранения автоматически создаются два модуля: `text` и `quiz` с заданными значениями.
6. По желанию можно дублировать материал или отдельный модуль.

## Дублирование
- **Материал**: создаёт копию с суффиксом «(копия)», статус — Скрыт. Копируются модули (с порядком и метой) и вопросы (включая ответы и пояснения).
- **Модуль**: копию добавляет в конец списка модулей, в названии появляется «(копия)».

## Предпросмотр
- Страница `/superadmin/courses/:courseId/preview` показывает материал так, как его видит пользователь.
- Параметр `?preview=true` в ссылке на модуль включает режим, в котором прогресс/результаты не записываются.

## Важно перед выкладкой
- Проверить пул вопросов: в каждом материале квиза должно быть >= чем `questionCount`. Иначе старт будет запрещён.
- Провести smoke-тест дубликатов и мастера (создание, проверка модулей, удаление).
- Убедиться, что справочник содержит реальные группы/теги, а пользователи привязаны к нужным группам.
- Продумать план резервного копирования SQLite (копия файла, cron и т.п.).

Готово к продакшену после реализации оставшейся задачи из roadmap — улучшений UX квиза (при необходимости можно расширить объяснения или добавить аналитику).
