# Этап C — Управление администрацией и разрешениями

**Цель:** предоставить суперадмину инструменты для полного управления администраторами, их ролями и доступами без участия разработчиков, дополнительно введя аудит действий.

## Область работ
- Внедрение ролевой модели с привязкой гранулярных разрешений (RBAC).
- CRUD для учёток администрации: создание, блокировка, удаление, восстановление, назначение/отзыв ролей.
- Централизованный аудит всех административных операций.

## Ключевые результаты
- Схема RBAC с возможностью добавлять новые разрешения без миграции кода (конфигурация через БД).
- Веб-интерфейс для суперадмина: список админов, фильтры, статусы, назначенные роли, история действий.
- REST API c валидацией прав (`requirePermissions`) и унифицированным ответом об ошибках доступа.
- Audit log с неизменяемыми событиями: создание/удаление учётки, изменение ролей, сброс пароля, вход/выход.
- Отчётность: выгрузка лога (CSV/JSON) и панель быстрых фильтров (по пользователю, по действию, по дате).

## Workstreams
### RBAC архитектура
- Таблицы: `roles`, `permissions`, `role_permissions`, `user_roles`, `user_permission_overrides`.
- Перечень базовых ролей:
  - `superadmin` (полный доступ).
  - `admin_manager` (создание/редактирование студентов, но без удаления).
  - `content_manager` (работа с курсами, без управления пользователями).
- Механизм overrides: точечная выдача/отзыв отдельного разрешения на уровне пользователя.

### Backend
- Middleware `requirePermissions(...keys)` с поддержкой логирования отказов.
- Эндпойнты: `/superadmin/admins` (GET/POST/PATCH/DELETE), `/superadmin/admins/:id/roles`, `/superadmin/admins/:id/permissions`, `/superadmin/audit`.
- Сервис аудита: запись события (actorId, actionKey, targetType, meta JSON, IP, userAgent, createdAt).
- Миграции данных: перевод существующих админов в новую модель (пресеты ролей).

### Frontend (панель суперадмина)
- Каталог админов: фильтры по статусу, ролям, дате создания, серверу.
- Форма создания/редактирования учётки: ФИО, логин, статический ID, сервер, назначение ролей и индивидуальных разрешений.
- Модальное окно удаления/деактивации с подтверждением и указанием причины (для лога).
- Экран аудита: таблица событий, быстрые преднастроенные фильтры (например, «изменения прав за неделю»), экспорт.
- Уведомления пользователю о критичных действиях (например, роль обновлена).

### QA и безопасность
- Тесты на проверку разрешений (попытка доступа без права → 403).
- E2E кейсы: создание админа, смена роли, отзыв доступа, проверка аудит-лога.
- Политика сложных паролей и напоминания о регулярной смене (при необходимости).

### Документация и процессы
- Регламент «Как управлять правами администратора».
- Справочник разрешений (ключ, описание, пример использования).
- Настройка регулярного ревью прав (раз в квартал).

## Зависимости
- Завершённый Этап B (нужен раздел документации для регламентов RBAC).
- Полномочия на изменение схемы БД и миграций.
- Взаимодействие с безопасностью/комплаенсом для утверждения набора разрешений.

## Риски и меры
- **Сложность интерфейса.** → Использовать пресеты/роли по умолчанию, скрывать продвинутые настройки в «расширенный режим».
- **Нарушение целостности прав.** → Ввести миграцию-скрипт для проверки консистентности (роль ↔ разрешения).
- **Рост объёма аудита.** → Архивировать события старше N месяцев либо вынести в отдельную таблицу/хранилище.

## Метрики успеха
- 100 % административных операций проходят через новую RBAC-систему.
- Время выдачи прав новому админу ≤ 5 минут (из UI, без ручных вмешательств).
- Аудит покрывает минимум 10 типов событий и доступен для фильтрации ≤ 1 секунды на выборку 10 000 записей.

## Таймлайн (оценка)
- **Неделя 1:** проектирование RBAC, миграции, базовые API, заглушки UI.
- **Неделя 2:** фронтенд управления правами, аудит, миграция текущих админов.
- **Неделя 3:** e2e и нагрузочные тесты, документация, демонстрация функционала.
