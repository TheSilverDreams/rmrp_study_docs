# Этап D — Безопасность, сессии и мастер-панель суперадмина

**Цель:** повысить защищённость портала и дать суперадмину централизованную панель наблюдаемости (2FA, контроль сессий, журнал авторизаций, IP-аналитика).

## Область работ
- Обязательная двухфакторная аутентификация для суперадминов, опциональная — для остальных ролей.
- Учёт и управление активными сессиями, логирование авторизаций (включая IP, user-agent, геолокацию).
- Мастер-панель суперадмина с ключевыми метриками безопасности и быстродействующими контролями.

## Ключевые результаты
- TOTP 2FA (RFC 6238) с генерацией секретов, резервными кодами и возможностью принудительного включения.
- Step-up аутентификация для высокорисковых операций (изменение прав, удаление учётки, доступ к аудиту).
- Хранилище сессий (`auth_sessions`) и API для просмотра/отзыва токенов.
- Логи авторизаций: успешные/неуспешные входы, IP, устройство, география, причина отказа.
- Мастер-панель суперадмина: живые виджеты (мониторинг входов, попыток взлома, активных сессий), быстрые фильтры, поиск.

## Workstreams
### Безопасность и аутентификация
- Хранение TOTP-секретов в зашифрованном виде (например, AES-256 с ключом из переменной окружения).
- API: включение/отключение 2FA, проверка OTP при логине, генерация и управление резервными кодами.
- Валидация устройств: пометка «доверенных» браузеров, срок действия trust-cookie (опционально).
- Step-up flow: требовать подтверждения OTP перед выполнением критичных действий.

### Управление сессиями
- Таблица `auth_sessions` с полями: `id`, `userId`, `createdAt`, `lastSeenAt`, `ip`, `userAgent`, `isActive`, `terminationReason`.
- Middleware, записывающий обновление `lastSeenAt` и связанный IP/UA при каждом запросе.
- API для просмотра сессий (`GET /superadmin/security/sessions`) и завершения (`POST /superadmin/security/sessions/:id/terminate`).
- Логика автоматического завершения: истёкший срок, смена пароля, отзыв прав.

### Лог авторизаций
- Таблица `auth_events`: `userId`, `eventType` (login_success, login_failure, otp_failure, password_change), `ip`, `geo`, `userAgent`, `meta`.
- Интеграция GeoIP (локальная база MaxMind Lite либо внешний сервис с кэшированием).
- Настройка rate limiting и регистрация блокировок по IP/учётке.
- Экспорт событий и фильтры по периоду, IP, типу события.

### Мастер-панель суперадмина
- Дашборд с виджетами:
  - активные сессии (по ролям, по серверам, top IP);
  - график логинов/ошибок авторизации за неделю;
  - список подозрительных активностей (много OTP-fail, необычная география);
  - последние изменения прав/step-up подтверждения.
- Быстрые действия: отключить 2FA пользователю, завершить все сессии пользователя, заблокировать IP.
- Настройки политики безопасности: минимальная длина пароля, срок жизни сессии, требования по 2FA.

### DevOps и инфраструктура
- Хранение ключей шифрования и секретов 2FA в безопасном хранилище (Vault/KMS).
- Настройка алёртов (email/Slack) при превышении порога неудачных входов или при входе с новых стран.
- План отката: как отключить 2FA для пользователя в случае потери доступа (процедура восстановления с ручной верификацией).

### Документация и обучение
- Гайд для администраторов «Как включить 2FA», «Как управлять сессиями».
- Инструкция для службы поддержки по восстановлению доступа.
- Описание политики безопасности и требований по паролям/2FA.

## Зависимости
- Реализованный Этап C (RBAC) — требуется, чтобы ограничить доступ к панели безопасности.
- Доступ к инфраструктуре для хранения секретов и настройки алёртов.
- Решение по GeoIP и допустимости обработки IP с точки зрения комплаенса.

## Риски и меры
- **Потеря доступа из-за 2FA.** → Резервные коды, процедура ручной верификации, возможность временно отключить 2FA через суперадмина.
- **Рост нагрузки на БД от логов.** → Архивирование в отдельную таблицу/хранилище, агрегации по дням.
- **Ложные срабатывания по гео.** → Пороговые значения и whitelists, уведомления без автопенализации.

## Метрики успеха
- 100 % суперадминов работают с обязательной 2FA.
- Возможность отозвать сессию в течение ≤10 секунд после запроса.
- Алёрты о подозрительных входах доставляются в канал безопасности в течение 1 минуты.
- Нет незадокументированных способов входа в систему без 2FA.

## Таймлайн (оценка)
- **Неделя 1:** реализация 2FA и step-up flow, миграции, UI для настройки.
- **Неделя 2:** лог сессий и авторизаций, интеграция GeoIP, API для управления.
- **Неделя 3:** мастер-панель, алёрты, документация, обучение команды.
